name: ğŸ·ï¸ Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ========================================
  # Create GitHub Release
  # ========================================
  create-release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“ Generate changelog
      id: changelog
      run: |
        # Get changes since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          CHANGES=$(git log $LAST_TAG..HEAD --oneline --pretty=format:"- %s")
        else
          CHANGES=$(git log --oneline --pretty=format:"- %s")
        fi
        
        # Create changelog
        echo "## ğŸš€ Changes in ${{ steps.version.outputs.version }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "$CHANGES" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ”’ Security" >> CHANGELOG.md
        echo "- Next.js updated to secure version 16.0.10" >> CHANGELOG.md
        echo "- All dependencies audited for vulnerabilities" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ³ Docker Images" >> CHANGELOG.md
        echo "- \`ghcr.io/${{ github.repository }}-app:${{ steps.version.outputs.version }}\`" >> CHANGELOG.md
        echo "- \`ghcr.io/${{ github.repository }}-auth:${{ steps.version.outputs.version }}\`" >> CHANGELOG.md
        
    - name: ğŸ—ï¸ Build release assets
      run: |
        # Create release package
        mkdir -p release-assets
        
        # Package source code
        tar -czf release-assets/source-code.tar.gz \
          --exclude=node_modules \
          --exclude=.next \
          --exclude=.git \
          --exclude=coverage \
          .
          
        # Create deployment scripts package
        tar -czf release-assets/deployment-scripts.tar.gz \
          decision-platform/scripts/ \
          decision-platform/docker-compose.*.yml \
          decision-platform/.env.* \
          Makefile
        
    - name: ğŸ“¦ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body_path: CHANGELOG.md
        files: |
          release-assets/source-code.tar.gz
          release-assets/deployment-scripts.tar.gz
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, '-') }}

  # ========================================
  # Build and Push Release Images
  # ========================================
  build-release-images:
    name: ğŸ³ Build Release Images
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        service: [app, auth]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: ğŸ³ Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: ./decision-platform${{ matrix.service == 'app' && '' || format('/services/{0}', matrix.service) }}
        file: ./decision-platform${{ matrix.service == 'app' && '/Dockerfile' || format('/services/{0}/Dockerfile', matrix.service) }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ========================================
  # Deploy Release to Production
  # ========================================
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [create-release, build-release-images]
    environment:
      name: production
      url: https://fa.example.com
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to production
      run: |
        echo "ğŸ­ Deploying to production..."
        # This would typically involve:
        # 1. SSH to production server
        # 2. Pull new images
        # 3. Run deployment script
        # 4. Verify health
        
        echo "Production deployment completed!"
        
    - name: ğŸ“¢ Notify successful release
      uses: 8398a7/action-slack@v3
      if: success()
      with:
        status: success
        channel: '#releases'
        text: |
          ğŸ‰ New release deployed successfully!
          Version: ${{ github.ref_name }}
          Deployed by: ${{ github.actor }}
          Environment: Production
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        
    - name: ğŸ“¢ Notify failed release
      uses: 8398a7/action-slack@v3
      if: failure()
      with:
        status: failure
        channel: '#alerts'
        text: |
          ğŸš¨ Production deployment failed!
          Version: ${{ github.ref_name }}
          Please check the logs and take immediate action.
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}